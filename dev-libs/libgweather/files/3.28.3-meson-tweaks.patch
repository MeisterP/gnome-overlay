From 7d2102fdab161c5920069894cd0ed2f18ebc4a21 Mon Sep 17 00:00:00 2001
From: Mart Raudsepp <leio@gentoo.org>
Date: Sat, 23 Feb 2019 12:21:01 +0200
Subject: [PATCH] build: Provide introspection option and don't build manual
 tests

---
 libgweather/meson.build | 21 ++++++++++++++-------
 meson.build             |  4 ++++
 meson_options.txt       |  2 ++
 3 files changed, 20 insertions(+), 7 deletions(-)

diff --git a/libgweather/meson.build b/libgweather/meson.build
index 301e7e8..9eb1097 100644
--- a/libgweather/meson.build
+++ b/libgweather/meson.build
@@ -65,6 +65,15 @@ lib_libgweather = shared_library('gweather-3',
   install: true,
 )
 
+libgweather_dep = declare_dependency(
+  sources: [gweather_enum_types[1]],
+  dependencies: deps_libgweather,
+  link_with: lib_libgweather,
+  include_directories: root_inc,
+)
+
+if get_option('introspection')
+
 gweather_gir = gnome.generate_gir(lib_libgweather,
   sources: introspection_sources,
   dependencies: deps_libgweather,
@@ -82,13 +91,6 @@ gweather_gir = gnome.generate_gir(lib_libgweather,
   install: true,
 )
 
-libgweather_dep = declare_dependency(
-  sources: [gweather_enum_types[1], gweather_gir],
-  dependencies: deps_libgweather,
-  link_with: lib_libgweather,
-  include_directories: root_inc,
-)
-
 if enable_vala
   gnome.generate_vapi('gweather-3.0',
     sources: gweather_gir[0],
@@ -97,11 +99,13 @@ if enable_vala
     install: true
   )
 endif
+endif
 
 test_cargs = ['-DTEST_SRCDIR="@0@/"'.format(meson.current_source_dir()),
               '-DSCHEMASDIR="@0@/schemas"'.format(meson.source_root()),
               '-DSCHEMAS_BUILDDIR="@0@/schemas"'.format(meson.build_root())]
 
+if false
 executable('test_locations',
   ['test_locations.c'],
   c_args: test_cargs,
@@ -112,6 +116,7 @@ executable('test_locations_utc',
   c_args: test_cargs,
   dependencies: libgweather_dep,
   install: false)
+endif
 
 exe = executable('test_libgweather',
   ['test_libgweather.c'],
@@ -120,6 +125,7 @@ exe = executable('test_libgweather',
   install: false)
 test('test_named_timezones', exe)
 
+if false
 executable('test_metar',
   ['test_metar.c', gweather_c_sources],
   c_args: test_cargs,
@@ -130,3 +136,4 @@ executable('test_sun_moon',
   c_args: test_cargs,
   dependencies: libgweather_dep,
   install: false)
+endif
diff --git a/meson.build b/meson.build
index eb27da4..70f0323 100644
--- a/meson.build
+++ b/meson.build
@@ -108,6 +108,10 @@ else
   enable_vala = enable_vala != 'false'
 endif
 
+if enable_vala and not get_option('introspection')
+  error('Vala bindings require introspection support')
+endif
+
 root_inc = include_directories('.')
 
 subdir('libgweather')
diff --git a/meson_options.txt b/meson_options.txt
index 19b2c6a..bf4c517 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -8,3 +8,5 @@ option('enable_vala', type: 'combo', choices : ['true', 'false', 'auto'], value
        description: 'Install vala bindings')
 option('gtk_doc', type: 'boolean', value: false,
        description: 'Whether to generate the API reference')
+option('introspection', type: 'boolean', value: true,
+       description: 'generate GObject Introspection data')
-- 
2.19.2

