From 5a668b0557f4ee83313e6e678ac0cf7a31b6dd3d Mon Sep 17 00:00:00 2001
From: Mart Raudsepp <leio@gentoo.org>
Date: Mon, 4 Mar 2019 00:49:18 +0200
Subject: [PATCH 2/5] build: Make kerberos optional

---
 meson.build                             | 5 +++++
 meson_options.txt                       | 1 +
 panels/user-accounts/cc-realm-manager.c | 9 +++++++++
 panels/user-accounts/meson.build        | 4 ----
 4 files changed, 15 insertions(+), 4 deletions(-)

diff --git a/meson.build b/meson.build
index b6f8d0945..3bec6109d 100644
--- a/meson.build
+++ b/meson.build
@@ -235,6 +235,11 @@ config_h.set('HAVE_WACOM', enable_wacom,
 config_h.set('BUILD_THUNDERBOLT', host_is_linux_not_s390,
              description: 'Define to 1 to build the Thunderbolt panel')
 
+# Kerberos support
+krb_dep = dependency('krb5', required: get_option('kerberos'))
+config_h.set('HAVE_KERBEROS', krb_dep.found(),
+             description: 'Define to 1 if kerberos support is available')
+
 # Check for info panel
 gnome_session_libexecdir = get_option('gnome_session_libexecdir')
 if gnome_session_libexecdir == ''
diff --git a/meson_options.txt b/meson_options.txt
index 28ab74430..fd7895cde 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -3,6 +3,7 @@ option('cheese', type: 'boolean', value: true, description: 'build with cheese w
 option('documentation', type: 'boolean', value: false, description: 'build documentation')
 option('gnome_session_libexecdir', type: 'string', value: '', description: 'Directory for gnome-session\'s libexecdir')
 option('ibus', type: 'boolean', value: true, description: 'build with IBus support')
+option('kerberos', type: 'feature', value: 'auto', description: 'build with kerberos support')
 option('network_manager', type: 'boolean', value: true, description: 'build with NetworkManager support')
 option('tracing', type: 'boolean', value: false, description: 'add extra debugging information')
 option('wacom', type: 'boolean', value: true, description: 'build with Wacom support')
diff --git a/panels/user-accounts/cc-realm-manager.c b/panels/user-accounts/cc-realm-manager.c
index dd61c1312..78703c80d 100644
--- a/panels/user-accounts/cc-realm-manager.c
+++ b/panels/user-accounts/cc-realm-manager.c
@@ -22,7 +22,9 @@
 
 #include "cc-realm-manager.h"
 
+#ifdef HAVE_KERBEROS
 #include <krb5/krb5.h>
+#endif
 
 #include <glib.h>
 #include <glib/gi18n.h>
@@ -613,6 +615,7 @@ login_closure_free (gpointer data)
         g_slice_free (LoginClosure, login);
 }
 
+#ifdef HAVE_KERBEROS
 static krb5_error_code
 login_perform_kinit (krb5_context k5,
                      const gchar *realm,
@@ -676,6 +679,7 @@ login_perform_kinit (krb5_context k5,
 
         return code;
 }
+#endif
 
 static void
 kinit_thread_func (GTask *task,
@@ -683,6 +687,7 @@ kinit_thread_func (GTask *task,
                    gpointer task_data,
                    GCancellable *cancellable)
 {
+#ifdef HAVE_KERBEROS
         LoginClosure *login = task_data;
         krb5_context k5 = NULL;
         krb5_error_code code;
@@ -763,6 +768,10 @@ kinit_thread_func (GTask *task,
                 krb5_free_context (k5);
 
         g_object_unref (task);
+#else
+        g_task_return_new_error (task, CC_REALM_ERROR, CC_REALM_ERROR_GENERIC,
+                                 _("gnome-control-center was built without kerberos support"));
+#endif
 }
 
 void
diff --git a/panels/user-accounts/meson.build b/panels/user-accounts/meson.build
index b1c322a6b..b5d0bc9e5 100644
--- a/panels/user-accounts/meson.build
+++ b/panels/user-accounts/meson.build
@@ -156,10 +156,6 @@ sources = common_sources + files(
   'um-fingerprint-dialog.c',
 )
 
-# Kerberos support
-krb_dep = dependency('krb5', required: false)
-assert(krb_dep.found(), 'kerberos libraries not found in your path')
-
 deps = common_deps + [
   accounts_dep,
   gdk_pixbuf_dep,
-- 
2.21.0

