From e483e619adea9a9be2f14080c9c799f9c56552b1 Mon Sep 17 00:00:00 2001
From: Mart Raudsepp <leio@gentoo.org>
Date: Mon, 4 Mar 2019 01:25:49 +0200
Subject: [PATCH 4/7] make cups optional

---
 meson.build             | 9 +++++++--
 meson_options.txt       | 1 +
 panels/meson.build      | 5 ++++-
 shell/cc-panel-loader.c | 4 ++++
 4 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/meson.build b/meson.build
index b285198fb..d6db61d00 100644
--- a/meson.build
+++ b/meson.build
@@ -145,9 +145,10 @@ common_deps = [
 ]
 
 # Check for CUPS 1.4 or newer
-cups_dep = dependency('cups', version : '>= 1.4', required: false)
-assert(cups_dep.found(), 'CUPS 1.4 or newer not found')
+cups_dep = dependency('cups', version : '>= 1.4', required: get_option('cups'))
+enable_cups = cups_dep.found()
 
+if enable_cups
 # https://bugzilla.gnome.org/show_bug.cgi?id=696766
 cups_cflags = []
 if cups_dep.version().version_compare('>= 1.6')
@@ -163,6 +164,9 @@ check_headers = [
 foreach header: check_headers
   assert(cc.has_header(header[1], args: cups_cflags), 'CUPS headers not found: ' + header[1])
 endforeach
+endif
+config_h.set('BUILD_PRINTERS', enable_cups,
+             description: 'Define to 1 to build the Printers panel')
 
 # Optional dependency for the user accounts panel
 enable_cheese = get_option('cheese')
@@ -299,6 +303,7 @@ output += '     Cheese (Users panel webcam support) ........ ' + enable_cheese.t
 output += '     IBus (Region panel IBus support) ........... ' + enable_ibus.to_string() + '\n'
 output += '     NetworkManager (Network panel) ............. ' + enable_network.to_string() + '\n'
 output += '     Wacom (Wacom tablet panel) ................. ' + enable_wacom.to_string() + '\n'
+output += '     Cups (Printer panel) ....................... ' + enable_cups.to_string() + '\n'
 output += '     Wayland .................................... ' + enable_wayland.to_string() + '\n'
 
 message(output)
diff --git a/meson_options.txt b/meson_options.txt
index ac5186228..dc9657120 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -1,4 +1,5 @@
 option('cheese', type: 'boolean', value: true, description: 'build with cheese webcam support')
+option('cups', type: 'feature', value: 'auto', description: 'build with CUPS support')
 option('documentation', type: 'boolean', value: false, description: 'build documentation')
 option('gnome_session_libexecdir', type: 'string', value: '', description: 'Directory for gnome-session\'s libexecdir')
 option('ibus', type: 'boolean', value: true, description: 'build with IBus support')
diff --git a/panels/meson.build b/panels/meson.build
index 9a0dc0d1f..5b1bfdb8f 100644
--- a/panels/meson.build
+++ b/panels/meson.build
@@ -12,7 +12,6 @@ panels = [
   'notifications',
   'online-accounts',
   'power',
-  'printers',
   'privacy',
   'region',
   'search',
@@ -26,6 +25,10 @@ if enable_wacom
   panels += ['wacom']
 endif
 
+if enable_cups
+  panels += ['printers']
+endif
+
 if enable_network
   panels += ['network']
 endif
diff --git a/shell/cc-panel-loader.c b/shell/cc-panel-loader.c
index 5eeb44e60..1fc5eb73b 100644
--- a/shell/cc-panel-loader.c
+++ b/shell/cc-panel-loader.c
@@ -51,7 +51,9 @@ extern GType cc_wifi_panel_get_type (void);
 extern GType cc_notifications_panel_get_type (void);
 extern GType cc_goa_panel_get_type (void);
 extern GType cc_power_panel_get_type (void);
+#ifdef BUILD_PRINTERS
 extern GType cc_printers_panel_get_type (void);
+#endif
 extern GType cc_privacy_panel_get_type (void);
 extern GType cc_region_panel_get_type (void);
 extern GType cc_search_panel_get_type (void);
@@ -104,7 +106,9 @@ static CcPanelLoaderVtable default_panels[] =
   PANEL_TYPE("notifications",    cc_notifications_panel_get_type,        NULL),
   PANEL_TYPE("online-accounts",  cc_goa_panel_get_type,                  NULL),
   PANEL_TYPE("power",            cc_power_panel_get_type,                NULL),
+#ifdef BUILD_PRINTERS
   PANEL_TYPE("printers",         cc_printers_panel_get_type,             NULL),
+#endif
   PANEL_TYPE("privacy",          cc_privacy_panel_get_type,              NULL),
   PANEL_TYPE("region",           cc_region_panel_get_type,               NULL),
   PANEL_TYPE("search",           cc_search_panel_get_type,               NULL),
-- 
2.19.2

